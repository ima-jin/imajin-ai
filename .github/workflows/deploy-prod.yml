name: Deploy to Prod

on:
  push:
    tags: ['v*']

jobs:
  deploy:
    runs-on: self-hosted
    defaults:
      run:
        working-directory: /home/jin/prod/imajin-ai
    env:
      PATH: /home/jin/.nvm/versions/node/v22.22.0/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

    steps:
      - name: Pull latest tag
        run: |
          git fetch origin --tags
          git reset --hard ${{ github.ref_name }}

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build all apps
        run: pnpm build

      - name: Push schemas
        run: |
          for app in auth profile registry www events chat; do
            cd /home/jin/prod/imajin-ai/apps/$app
            DATABASE_URL=$(grep DATABASE_URL .env.local | cut -d'"' -f2) npx drizzle-kit push --force 2>&1 | tail -2
          done

      - name: Restart prod services
        run: |
          pm2 restart www auth pay profile events chat registry connections 2>/dev/null || true
          echo "Prod services restarted"
